<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Design by Free CSS Templates
http://www.freecsstemplates.org
Released for free under a Creative Commons Attribution 2.5 License

Name       : Brown Stone  
Description: A two-column, fixed-width design with dark color scheme.
Version    : 1.0
Released   : 20100928

-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>自动获取Nexus4售卖状态的Python脚本</title>
<link href="http://smilehacker.com/theme/css/style.css" rel="stylesheet" type="text/css" media="screen" />
<link href="http://smilehacker.com/" type="application/atom+xml" rel="alternate" title="SmileHacker ATOM Feed" />
</head>
<body>
<div id="wrapper">
	<div id="page">
		<div id="page-bgtop">
			<div id="page-bgbtm">
				    
                        	<div id="content">
					<div class="post">
						<h2 class="title"><a href="zi-dong-huo-qu-nexus4shou-mai-zhuang-tai-de-pythonjiao-ben.html">自动获取Nexus4售卖状态的Python脚本</a></h2>
						<p class="meta"><span class="date">Le 四 07 二月 2013 </span><span class="posted">Par <a href="#">Sai</a></span><span>&nbsp; | Catégorie : <a href="http://smilehacker.com/category/code.html">code</a></span></p>
					<p class="meta">Tags : <span><a href="http://smilehacker.com/tag/python.html">Python</a> / </span>
</p>	
						<div style="clear: both;">&nbsp;</div>
						<div class="entry">
						 <hr />
<p><img src="static/images/nexus4.png" alt="Nexus" style="width: 630px;"/><br />
使用pyquery做爬虫解析GooglePlay页面 获取状态
然后通过Gmail发给指定邮箱
每隔一个小时自动检测一次
使用 <code><strong>nohup python *.py &amp;</strong></code> 可在后台运行</p>
<!-- more -->

<div class="highlight"><pre><span class="c">#coding=utf-8</span>
<span class="c"># easy_install pyquery OR sudo apt-get install python-pyquery</span>
<span class="kn">from</span> <span class="nn">pyquery</span> <span class="kn">import</span> <span class="n">PyQuery</span> <span class="k">as</span> <span class="n">pq</span>
<span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">from</span> <span class="nn">email.Message</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c"># 发给谁</span>
<span class="n">mailto_list</span> <span class="o">=</span> <span class="s">&quot;xxx@xx.xx&quot;</span>
<span class="c"># 设置服务器 用户名 口令 邮箱后缀</span>
<span class="n">mail_host</span> <span class="o">=</span> <span class="s">&quot;smtp.gmail.com&quot;</span>
<span class="n">mail_user</span> <span class="o">=</span> <span class="s">&quot;xxx@gmail.com&quot;</span>
<span class="n">mail_pass</span> <span class="o">=</span> <span class="s">&quot;you password&quot;</span>

<span class="k">def</span> <span class="nf">sendMail</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    sub:主题</span>
<span class="sd">    content:内容</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">()</span>
    <span class="n">msg</span><span class="p">[</span><span class="s">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span>
    <span class="n">msg</span><span class="p">[</span><span class="s">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mail_user</span>
    <span class="n">msg</span><span class="p">[</span><span class="s">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mailto_list</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">mail_host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">587</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">mail_user</span><span class="p">,</span> <span class="n">mail_pass</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">mail_user</span><span class="p">,</span> <span class="n">mailto_list</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">checkSoldState</span><span class="p">():</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">pq</span><span class="p">(</span><span class="n">url</span> <span class="o">=</span> <span class="s">r&#39;https://play.google.com/store/devices/details?id=nexus_4_16gb&#39;</span><span class="p">)</span>
    <span class="n">soldMsg</span> <span class="o">=</span> <span class="n">doc</span><span class="p">(</span><span class="s">&#39;span&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;.hardware-price-description&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">soldMsg</span>
    <span class="k">if</span> <span class="n">soldMsg</span> <span class="o">!=</span> <span class="s">&#39;Sold out&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;sent mail&#39;</span>
        <span class="n">sendMail</span><span class="p">(</span><span class="s">&#39;Nexus4 Info&#39;</span><span class="p">,</span> <span class="s">&#39;Sold out&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">say</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&quot;hello&quot;</span>

<span class="c"># main</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">checkSoldState</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3600</span><span class="p">)</span>
</pre></div>	
												</div>
					</div>
			      
					<div style="clear: both;">&nbsp;</div>
					                                         <div class="post">
                                        <h2 class="title">Commentaires !</h2>
                                            <div id="disqus_thread"></div>
                                            <script type="text/javascript">
                                               var disqus_identifier = "zi-dong-huo-qu-nexus4shou-mai-zhuang-tai-de-pythonjiao-ben.html";
                                               (function() {
                                               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                                               dsq.src = 'http://smilehacker.disqus.com/embed.js';
                                               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                                              })();
                                            </script>
                                        </div>
                                        				</div>
				<!-- end #content -->
				<div id="sidebar">
					<div id="logo">
						<h1><a href="http://smilehacker.com">SmileHacker</h1>
											</div>
					<div id="menu">
						<ul>
							<li class="current_page_item"><a href="http://smilehacker.com">Home</a></li>
							<li><a href="http://smilehacker.com/archives.html">Archives</a></li>
							                                                                                                                    <li><a href="http://smilehacker.com/pages/about.html">About</a></li>
                                                                                                                						</ul>
					</div>
					<ul>
						<li>
							<h2>Catégories</h2>
							<ul>
															 <li class="active"><a href="http://smilehacker.com/category/code.html">code</a></li>
															 <li ><a href="http://smilehacker.com/category/tech.html">tech</a></li>
															 <li ><a href="http://smilehacker.com/category/write.html">write</a></li>
														</ul>
						</li>
												                                                <li>
                                                        <h2>Social</h2>
                                                        <ul>
                                                            <li><a href="http://smilehacker.com/" rel="alternate">Flux Atom</a></li>
                                                                                                                                                                                <li><a href="http://weibo.com/zhouquanbest">@Weibo</a></li>
                                                                                                                    <li><a href="http://www.douban.com/people/zhouquanbest/">Douban</a></li>
                                                                                                                </ul>
                                                </li><!-- /.social -->
                                                						<li>
						        <h2>Tags</h2>
						        <ul>
						                                                                        <li><a href="http://smilehacker.com/tag/.html"></a></li>
                                                                                                                        <li><a href="http://smilehacker.com/tag/poem.html">poem</a></li>
                                                                                                                        <li><a href="http://smilehacker.com/tag/life.html">life</a></li>
                                                                                                                        <li><a href="http://smilehacker.com/tag/novel.html">novel</a></li>
                                                                                                                        <li><a href="http://smilehacker.com/tag/douban.html">douban</a></li>
                                                                                                                        <li><a href="http://smilehacker.com/tag/python.html">Python</a></li>
                                                                                                                        <li><a href="http://smilehacker.com/tag/alg.html">alg</a></li>
                                                                                                                        <li><a href="http://smilehacker.com/tag/eclipse.html">eclipse</a></li>
                                                                                                                        <li><a href="http://smilehacker.com/tag/coder.html">coder</a></li>
                                                                                                                        <li><a href="http://smilehacker.com/tag/windows.html">windows</a></li>
                                                                                                                        <li><a href="http://smilehacker.com/tag/linux.html">linux</a></li>
                                                                                                                        <li><a href="http://smilehacker.com/tag/arch.html">arch</a></li>
                                                        						        </ul>
						</li>
						
						
					</ul>
				</div>
				<!-- end #sidebar -->
				<div style="clear: both;">&nbsp;</div>
			</div>
		</div>
	</div>
	<!-- end #page -->

<div id="footer">
	<p>Copyright (c) 2008 Sitename.com. All rights reserved. Design by <a href="http://www.freecsstemplates.org/">CSS Templates</a>.</p>
	<p>Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>, which takes great advantages of <a href="http://python.org">python</a>.
</p>
</div>
<!-- end #footer -->
</body>
</html>